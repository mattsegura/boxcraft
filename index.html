<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Watch and Manage Claude Code in 3D!" />
    <meta name="theme-color" content="#000000" />
    <title>Boxcraft - Watch and Manage Claude Code in 3D!</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    
    <!-- Preload critical resources -->
    <link rel="modulepreload" href="/src/main.ts" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.amplitude.com" crossorigin />

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Boxcraft" />
    <meta property="og:title" content="Boxcraft - Watch and Manage Claude Code in 3D!" />
    <meta property="og:description" content="Watch and Manage Claude Code in 3D!" />
    <meta property="og:image" content="https://boxcraft.sh/og-image.png" />
    <meta property="og:url" content="https://boxcraft.sh" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Boxcraft - Watch and Manage Claude Code in 3D!" />
    <meta name="twitter:description" content="Watch and Manage Claude Code in 3D!" />
    <meta name="twitter:image" content="https://boxcraft.sh/og-image.png" />

    <!-- Analytics (async, non-blocking) -->
    <script async src="https://cdn.amplitude.com/script/3b78e993d3c7ddad9fb9ae615cc094b6.js"></script>
    <script>
      // Initialize amplitude when script loads
      window.addEventListener('load', function() {
        if (window.amplitude) {
          window.amplitude.init('3b78e993d3c7ddad9fb9ae615cc094b6', {"fetchRemoteConfig":true,"autocapture":{"attribution":true,"fileDownloads":true,"formInteractions":true,"pageViews":true,"sessions":true,"elementInteractions":true,"networkTracking":true,"webVitals":true,"frustrationInteractions":true}});
        }
      });
    </script>
  </head>
  <body>
    <!-- Loading indicator -->
    <style>
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease-out;
      }
      #loading-screen.loaded {
        opacity: 0;
        pointer-events: none;
      }
      .loading-content {
        text-align: center;
        color: #fff;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255,255,255,0.1);
        border-top-color: #4ac8e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
    <div id="loading-screen">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div>Loading Boxcraft...</div>
      </div>
    </div>
    <div id="app">
      <!-- Left: 3D Scene -->
      <div id="scene-panel">
        <div id="canvas-container"></div>

        <!-- Scene HUD -->
        <div id="scene-hud">
          <div class="scene-badge unified-hud">
            <div id="status-dot"></div>
            <span id="username" class="hud-user">...</span>
            <span id="status-text"></span>
            <span class="hud-sep">|</span>
            <span id="token-counter" class="hud-tokens" title="Tokens used this session">0 tok</span>
            <span class="hud-sep">|</span>
            <button id="settings-btn" class="hud-btn" title="Settings">Settings</button>
            <!-- Debug: FPS counter (uncomment to enable)
            <span class="hud-sep">|</span>
            <span id="fps" class="hud-fps">-- FPS</span>
            -->
          </div>
        </div>

        <!-- Dev Panel (animations test) - hidden by default -->
        <div id="dev-panel" class="hidden">
          <div class="dev-header">üé¨ Animations</div>
          <div id="dev-animations"></div>
        </div>

        <!-- Keybind Helper (bottom-left) -->
        <div id="keybind-helper">
          <div class="keybind-list">
            <span class="keybind"><kbd>1-6</kbd> sessions ¬∑ <kbd>`</kbd><kbd>0</kbd> all ¬∑ <kbd>Tab</kbd> focus ¬∑ <kbd>D</kbd> draw</span>
          </div>
        </div>

        <!-- Voice Control (center bottom) -->
        <div id="voice-control" class="voice-control">
          <!-- Idle state: mic button with hint -->
          <div class="voice-idle">
            <button type="button" id="voice-btn" class="voice-trigger" title="Start voice input">üé§</button>
            <span class="voice-hint"><kbd>Ctrl</kbd><kbd>M</kbd></span>
          </div>
          <!-- Recording state: bars + dot -->
          <div class="voice-recording">
            <div class="voice-bars">
              <div class="voice-bar" data-bar="0"></div>
              <div class="voice-bar" data-bar="1"></div>
              <div class="voice-bar" data-bar="2"></div>
              <div class="voice-bar" data-bar="3"></div>
              <div class="voice-bar" data-bar="4"></div>
              <div class="voice-bar" data-bar="5"></div>
              <div class="voice-bar" data-bar="6"></div>
              <div class="voice-bar" data-bar="7"></div>
              <div class="voice-bar" data-bar="8"></div>
              <div class="voice-bar" data-bar="9"></div>
            </div>
            <div class="voice-status-row">
              <div class="voice-record-dot"></div>
              <span class="voice-send-hint"><kbd>Enter</kbd> to send</span>
            </div>
          </div>
        </div>

        <!-- Draw Mode UI (bottom right of scene) -->
        <div id="draw-indicator">
          <span class="draw-mode-label">DRAW MODE</span>
          <span class="draw-mode-hint"><kbd>D</kbd> exit ¬∑ <kbd>X</kbd> clear ¬∑ <kbd>Q</kbd><kbd>E</kbd> brush ¬∑ <kbd>R</kbd> 3D</span>
        </div>
        <div id="draw-palette">
          <!-- Populated by DrawMode.ts -->
        </div>

      </div>

      <!-- Right: Activity Feed -->
      <div id="feed-panel">
        <div id="feed-header">
          <h2>Boxcraft <span class="muted">(boxcraft.sh)</span></h2>
          <div class="feed-header-right">
            <span id="attention-badge" class="attention-badge hidden">0</span>
            <button id="about-btn" class="feed-about-btn" title="About Boxcraft">?</button>
          </div>
        </div>

        <!-- Session Management -->
        <div id="sessions-panel">
          <div id="sessions-header">
            <span class="sessions-title">SESSIONS</span>
            <button id="new-session-btn" title="Create new session">+ NEW</button>
          </div>
          <div id="sessions-list">
            <div class="session-item all-sessions active" data-session="all">
              <div class="session-hotkey">0</div>
              <div class="session-icon">üìã</div>
              <div class="session-info">
                <div class="session-name">All Sessions</div>
                <div class="session-detail" id="all-sessions-count">No active sessions</div>
              </div>
            </div>
            <div id="managed-sessions"></div>
          </div>
        </div>

        <!-- Terminal output panel (hidden by default) -->
        <div id="terminal-panel" class="hidden">
          <div id="terminal-output"></div>
        </div>

        <div id="activity-feed-wrapper">
          <div id="activity-feed">
            <div id="feed-empty">
              <div id="feed-empty-icon">üõ†Ô∏è</div>
              <h3>Waiting for activity</h3>
              <p>Start using Claude Code to see events here</p>
            </div>
          </div>
          <button id="feed-scroll-bottom">‚Üì Jump to latest</button>
        </div>

        <div id="prompt-container">
          <div id="voice-transcript">
            <div class="transcript-label"><span class="recording-dot"></span> Listening...</div>
            <div id="voice-transcript-text"></div>
          </div>
          <form id="prompt-form">
            <div class="input-wrapper">
              <textarea id="prompt-input" placeholder="Prompt..." autocomplete="off" rows="1"></textarea>
            </div>
            <button type="submit" id="prompt-submit"><span class="btn-icon">‚Üó</span> Send</button>
            <button type="button" id="prompt-cancel"><span class="btn-icon">‚óº</span> Stop</button>
          </form>
          <div id="prompt-options">
            <span id="prompt-target"></span>
            <span id="prompt-status"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- New Session Modal -->
    <div id="new-session-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>New Agent</h3>
        </div>

        <!-- Mode Toggle -->
        <div class="modal-field">
          <div class="mode-toggle">
            <button type="button" class="mode-btn active" data-mode="blackbox">Single Agent</button>
            <button type="button" class="mode-btn" data-mode="multi">Multi-Agent</button>
            <button type="button" class="mode-btn" data-mode="local">Local (tmux)</button>
          </div>
        </div>

        <!-- API Key Notice (shown when Blackbox not configured) -->
        <div id="blackbox-api-notice" class="api-notice hidden">
          <div class="notice-icon"></div>
          <div class="notice-content">
            <strong>API Key Required</strong>
            <p>Set <code>BLACKBOX_API_KEY</code> environment variable to enable cloud agents.</p>
            <p class="notice-hint">Get your API key from <a href="https://www.blackbox.ai" target="_blank">blackbox.ai</a></p>
          </div>
        </div>

        <!-- Single Agent Mode Fields -->
        <div id="blackbox-fields">
          <div class="modal-field">
            <label for="session-repo-input">GitHub Repository</label>
            <input type="text" id="session-repo-input" placeholder="https://github.com/user/repo.git" autocomplete="off" />
            <div class="field-hint">Required: Full GitHub repo URL</div>
          </div>

          <div class="modal-field">
            <label for="session-prompt-input">Task Prompt</label>
            <textarea id="session-prompt-input" placeholder="Describe what you want the agent to do..." rows="3"></textarea>
            <div class="field-hint">Be specific about the changes you want</div>
          </div>

          <div class="modal-field">
            <label for="session-branch-input">Branch</label>
            <input type="text" id="session-branch-input" placeholder="main" autocomplete="off" />
          </div>

          <div class="modal-field">
            <label>Agent & Model</label>
            <div class="agent-model-row">
              <select id="session-agent-select">
                <option value="blackbox">Blackbox</option>
                <option value="claude">Claude</option>
                <option value="codex">Codex</option>
                <option value="gemini">Gemini</option>
              </select>
              <select id="session-model-select">
                <!-- Populated dynamically -->
              </select>
            </div>
          </div>
        </div>

        <!-- Multi-Agent Mode Fields -->
        <div id="multi-agent-fields" class="hidden">
          <div class="modal-field">
            <label for="multi-repo-input">GitHub Repository</label>
            <input type="text" id="multi-repo-input" placeholder="https://github.com/user/repo.git" autocomplete="off" />
            <div class="field-hint">Required: Full GitHub repo URL</div>
          </div>

          <div class="modal-field">
            <label for="multi-prompt-input">Task Prompt</label>
            <textarea id="multi-prompt-input" placeholder="Describe what you want the agents to do..." rows="3"></textarea>
            <div class="field-hint">Same prompt will be sent to all selected agents</div>
          </div>

          <div class="modal-field">
            <label for="multi-branch-input">Branch</label>
            <input type="text" id="multi-branch-input" placeholder="main" autocomplete="off" />
          </div>

          <div class="modal-field">
            <label>Select Agents to Compare</label>
            <div class="multi-agent-grid">
              <label class="agent-checkbox">
                <input type="checkbox" id="multi-agent-blackbox" checked />
                <span class="agent-label">
                  <span class="agent-icon">‚ö´</span>
                  <span class="agent-name">Blackbox</span>
                </span>
              </label>
              <label class="agent-checkbox">
                <input type="checkbox" id="multi-agent-claude" checked />
                <span class="agent-label">
                  <span class="agent-icon">üü†</span>
                  <span class="agent-name">Claude</span>
                </span>
              </label>
              <label class="agent-checkbox">
                <input type="checkbox" id="multi-agent-codex" />
                <span class="agent-label">
                  <span class="agent-icon">üü¢</span>
                  <span class="agent-name">Codex</span>
                </span>
              </label>
              <label class="agent-checkbox">
                <input type="checkbox" id="multi-agent-gemini" />
                <span class="agent-label">
                  <span class="agent-icon">üîµ</span>
                  <span class="agent-name">Gemini</span>
                </span>
              </label>
            </div>
            <div class="field-hint">Select 2+ agents to compare their solutions</div>
          </div>

        </div>

        <!-- Local Mode Fields -->
        <div id="local-fields" class="hidden">
          <div class="modal-field">
            <label for="session-cwd-input">Directory</label>
            <div class="directory-input-row">
              <input type="text" id="session-cwd-input" placeholder="Click to select or start typing..." autocomplete="off" />
              <button type="button" id="browse-directory-btn" class="browse-btn" title="Browse folders">üìÅ</button>
            </div>
            <div class="field-hint">Select a project folder or type to search recent projects</div>
          </div>

          <div class="modal-field">
            <label>Options</label>
            <div class="modal-checkboxes">
              <label class="modal-checkbox">
                <input type="checkbox" id="session-opt-continue" />
                <span class="checkbox-label">Continue <code>-c</code></span>
              </label>
              <label class="modal-checkbox">
                <input type="checkbox" id="session-opt-skip-perms" checked />
                <span class="checkbox-label">Skip permissions <code>--dangerously-skip-permissions</code></span>
              </label>
              <label class="modal-checkbox">
                <input type="checkbox" id="session-opt-chrome" />
                <span class="checkbox-label">Chrome <code>--chrome</code></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Common Fields -->
        <div class="modal-field">
          <label for="session-name-input">Name</label>
          <input type="text" id="session-name-input" placeholder="Auto-generated from repo/directory..." autocomplete="off" />
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="modal-cancel">‚úï Cancel</button>
          <button type="button" class="modal-btn modal-btn-create" id="modal-create">+ Create</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Settings</h3>
        </div>

        <div class="modal-field">
          <label>Audio</label>
          <div class="settings-slider-row">
            <span class="slider-label">Volume</span>
            <input type="range" id="settings-volume" class="settings-slider" min="0" max="100" value="70" />
            <span id="settings-volume-value" class="slider-value">70%</span>
          </div>
          <div class="settings-checkbox-row">
            <label class="checkbox-label">
              <input type="checkbox" id="settings-spatial-audio" checked />
              <span>Spatial Audio</span>
            </label>
            <span class="field-hint-inline">Volume/pan based on zone position</span>
          </div>
        </div>

        <div class="modal-field">
          <label>Privacy</label>
          <div class="settings-checkbox-row">
            <label class="checkbox-label">
              <input type="checkbox" id="settings-streaming-mode" />
              <span>Streaming Mode</span>
            </label>
            <span class="field-hint-inline">Hide username for privacy</span>
          </div>
        </div>

        <div class="modal-field">
          <label>World</label>
          <div class="settings-slider-row">
            <span class="slider-label">Grid Size</span>
            <input type="range" id="settings-grid-size" class="settings-slider" min="5" max="80" value="20" />
            <span id="settings-grid-size-value" class="slider-value">20</span>
          </div>
          <div class="field-hint">Number of hex rings from center. Larger = more space, may impact performance.</div>
        </div>

        <div class="modal-field">
          <label>Agent Connection</label>
          <div class="settings-port-row">
            <span class="port-label">localhost:</span>
            <input type="number" id="settings-port" value="4003" min="1" max="65535" />
            <span id="settings-port-status" class="port-status"></span>
          </div>
          <div class="field-hint">Port where the Boxcraft agent is running. Changes require refresh.</div>
        </div>

        <div class="modal-field">
          <label>Sessions</label>
          <div class="settings-actions">
            <button type="button" class="settings-action-btn" id="settings-refresh-sessions">üîÑ Refresh Sessions</button>
          </div>
        </div>

        <div class="modal-field">
          <label>Keyboard Shortcuts</label>
          <div id="keybind-settings" class="keybind-settings">
            <!-- Dynamically populated by KeybindSettings.ts -->
          </div>
          <div class="field-hint">Click a keybind to change it. Press the new key combination, or Escape to cancel.</div>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="settings-close">‚úï Close</button>
        </div>
      </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal">
      <div class="modal-content about-modal-content">
        <div class="modal-header">
          <h3>Boxcraft</h3>
        </div>

        <div class="about-description">
          <p>Boxcraft is a A 3D visualization app for Claude Code.</p>
          <p>Watch and manage your claudes in real-time - now featuring hexagonal grids!</p>
          <p class="about-subtitle">Boxcraft syncs with claude code instances running on your own machine. No files or
          code are sent to the web server.</p>
        </div>

        <div class="about-section">
          <div class="about-section-title">Commands</div>
          <div class="about-commands">
            <div class="about-cmd"><code>npx boxcraft</code><span>Start server</span></div>
            <div class="about-cmd"><code>npx boxcraft doctor</code><span>Diagnose issues</span></div>
            <div class="about-cmd"><code>npx boxcraft setup</code><span>Reinstall hooks</span></div>
            <div class="about-cmd"><code>npx boxcraft uninstall</code><span>Remove hooks</span></div>
          </div>
        </div>

        <div class="about-section">
          <div class="about-section-title">Troubleshooting</div>
          <p class="about-help-text">If a zone gets stuck, Claude Code may be waiting for input or in an unknown state. Attach to the tmux session to see what's happening:</p>
          <div class="about-commands">
            <div class="about-cmd"><code>tmux ls</code><span>List sessions</span></div>
            <div class="about-cmd"><code>tmux attach -t <em>session</em></code><span>Attach to session</span></div>
          </div>
        </div>

        <div class="about-section">
          <div class="about-section-title">Voice Input</div>
          <p class="about-help-text">To enable voice input, add your Deepgram API key to <code>.env</code>:</p>
          <div class="about-commands">
            <div class="about-cmd"><code>DEEPGRAM_API_KEY=your_key_here</code></div>
          </div>
        </div>

        <div class="about-footer">
          <span id="about-version" class="about-version">v0.0.0</span>
          <span class="about-sep">¬∑</span>
          <span class="about-credit">Elysian Labs</span>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="about-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Question Modal (for AskUserQuestion) -->
    <div id="question-modal">
      <div class="modal-content question-modal-content">
        <div class="modal-header">
          <span class="question-badge" id="question-badge">Question</span>
          <h3 id="question-header">Claude needs input</h3>
        </div>

        <div class="question-text" id="question-text"></div>

        <div class="question-options" id="question-options">
          <!-- Options will be inserted here -->
        </div>

        <div class="question-other">
          <label for="question-other-input">Or type your own response:</label>
          <textarea id="question-other-input" placeholder="Type here..." rows="2"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="question-skip">Skip</button>
          <button type="button" class="modal-btn modal-btn-create" id="question-send-other">Send</button>
        </div>
      </div>
    </div>

    <!-- Permission Modal (for tool permissions) -->
    <div id="permission-modal">
      <div class="modal-content permission-modal-content">
        <div class="modal-header">
          <span class="permission-badge">Permission Required</span>
          <h3>Allow <span class="permission-tool" id="permission-tool">Tool</span>?</h3>
        </div>

        <div class="permission-context" id="permission-context">
          <!-- Context will be inserted here -->
        </div>

        <div class="permission-buttons" id="permission-buttons">
          <!-- Buttons will be generated dynamically based on options -->
        </div>
      </div>
    </div>

    <!-- Zone Info Modal (for session details) -->
    <div id="zone-info-modal">
      <div class="modal-content zone-info-modal-content">
        <div class="modal-header">
          <h3>Zone Info</h3>
          <button type="button" class="zone-info-close-btn" id="zone-info-close">&times;</button>
        </div>
        <div class="zone-info-body" id="zone-info-content">
          <!-- Content will be inserted dynamically -->
        </div>
      </div>
    </div>

    <!-- Text Label Modal (for hex text labels) -->
    <div id="text-label-modal">
      <div class="modal-content text-label-modal-content">
        <div class="modal-header">
          <h3 id="text-label-title">Add Label</h3>
        </div>

        <div class="text-label-body">
          <textarea
            id="text-label-input"
            class="text-label-textarea"
            placeholder="Enter your text here..."
            maxlength="500"
            rows="4"
          ></textarea>
          <div class="text-label-footer">
            <span class="text-label-char-count" id="text-label-char-count">0/500</span>
            <span class="text-label-hint">Enter to save, Shift+Enter for newline</span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="text-label-cancel">Cancel</button>
          <button type="button" class="modal-btn modal-btn-create" id="text-label-save">Save</button>
        </div>
      </div>
    </div>

    <!-- Zone Timeout Modal (shown when zone creation takes too long) -->
    <div id="zone-timeout-modal">
      <div class="modal-content zone-timeout-content">
        <div class="modal-header">
          <h3>Zone Not Responding</h3>
        </div>
        <p class="zone-timeout-text">
          The zone is taking longer than expected to start. Claude Code may be stuck or waiting for input.
        </p>
        <div class="about-section">
          <div class="about-section-title">Troubleshooting</div>
          <div class="about-commands">
            <div class="about-cmd"><code>tmux ls</code><span>List sessions</span></div>
            <div class="about-cmd"><code>tmux attach -t <em>session</em></code><span>See what's happening</span></div>
          </div>
        </div>
        <p class="zone-timeout-hint">Also ensure your Claude Code is up to date.</p>
        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-cancel" id="zone-timeout-close">Close</button>
        </div>
      </div>
    </div>

    <!-- Offline Banner (shown when user tries to interact while disconnected) -->
    <div id="offline-banner" class="offline-banner hidden">
      <span>Not connected to local server</span>
      <button id="offline-banner-dismiss">√ó</button>
    </div>

    <!-- Not Connected Overlay -->
    <div id="not-connected-overlay">
      <div class="not-connected-content">
        <h2>Boxcraft!</h2>
        <p class="not-connected-description">
          Boxcraft is a 3D app to watch and manage Claude Code instances.
        </p>
        <p class="not-connected-privacy">
          Boxcraft syncs with CC instances running on your local machine. Boxcraft is an interface - no files or code
          are sent to this server.
        </p>
        <div class="not-connected-setup">
          <p class="not-connected-setup-label">Get started:</p>
          <div class="not-connected-code">npx boxcraft setup && npx boxcraft</div>
        </div>
        <div class="not-connected-actions">
          <button class="not-connected-btn not-connected-btn-retry" id="retry-connection">Reconnect</button>
          <button class="not-connected-btn not-connected-btn-explore" id="explore-offline">Explore</button>
        </div>
      </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast-container"></div>

    <script type="module" src="/src/main.ts"></script>
    <script>
      // Hide loading screen when app is ready
      window.addEventListener('load', function() {
        setTimeout(function() {
          document.getElementById('loading-screen').classList.add('loaded');
        }, 100);
      });
    </script>
  </body>
</html>
